<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Note Online - Anotepad Clone</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìù</text></svg>" />
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f5f5f5; }
    
    header { background: #2c3e50; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    header h1 { font-size: 24px; font-weight: 600; }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    
    .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
    .main-grid { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
    
    .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .card h3 { margin-bottom: 15px; font-size: 18px; color: #2c3e50; }
    
    button { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
    button.primary { background: #3498db; color: white; }
    button.primary:hover { background: #2980b9; }
    button.secondary { background: #95a5a6; color: white; }
    button.secondary:hover { background: #7f8c8d; }
    button.ghost { background: transparent; border: 1px solid #bdc3c7; color: #2c3e50; }
    button.ghost:hover { background: #ecf0f1; }
    button.success { background: #27ae60; color: white; }
    button.success:hover { background: #229954; }
    button.danger { background: #e74c3c; color: white; }
    button.danger:hover { background: #c0392b; }
    
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #3498db; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #2c3e50; font-size: 14px; }
    
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #ecf0f1; }
    .tab { padding: 10px 20px; cursor: pointer; border: none; background: none; color: #7f8c8d; font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -2px; }
    .tab.active { color: #3498db; border-bottom-color: #3498db; }
    
    .note-list { list-style: none; }
    .note-item { padding: 12px; border-bottom: 1px solid #ecf0f1; cursor: pointer; transition: background 0.2s; }
    .note-item:hover { background: #f8f9fa; }
    .note-item.active { background: #e3f2fd; border-left: 3px solid #3498db; }
    .note-item-title { font-weight: 500; color: #2c3e50; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
    .note-item-title .note-icons { display: flex; gap: 4px; }
    .note-item-title .note-icons span { font-size: 12px; }
    .note-item-date { font-size: 12px; color: #95a5a6; }
    .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; }
    .badge-private { background: #ffeaa7; color: #d68910; }
    .badge-password { background: #dfe6e9; color: #636e72; }
    
    .editor-toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    
    #editor { min-height: 400px; background: white; }
    .ql-editor { min-height: 400px; font-size: 15px; }
    
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: white; border-radius: 8px; padding: 25px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h3 { font-size: 20px; color: #2c3e50; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #95a5a6; padding: 0; width: 30px; height: 30px; }
    
    .checkbox-group { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .checkbox-group input[type="checkbox"] { width: auto; }
    
    .btn-group { display: flex; gap: 10px; margin-top: 20px; }
    
    .hidden { display: none !important; }
    .muted { color: #95a5a6; font-size: 13px; }
    
    @media (max-width: 768px) {
      .main-grid { grid-template-columns: 1fr; }
      .sidebar { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <h1>üìù Note Online</h1>
    <div class="header-actions">
      <button id="btnShowAuth" class="ghost">ƒêƒÉng nh·∫≠p</button>
      <span id="authStatus" class="muted"></span>
    </div>
  </header>

  <div class="container">
    <div class="main-grid">
      <aside class="sidebar">
        <div class="card">
          <h3>Ghi ch√∫ c·ªßa t√¥i</h3>
          <button id="btnNew" class="primary" style="width:100%; margin-bottom:15px">+ T·∫°o m·ªõi</button>
          <ul id="notesList" class="note-list"></ul>
          <div id="guestMsg" class="muted hidden" style="margin-top:15px; text-align:center">Ch·∫ø ƒë·ªô kh√°ch - T·ªëi ƒëa 10 ghi ch√∫</div>
        </div>
      </aside>

      <main>
        <div class="card">
          <div class="tabs">
            <button class="tab active" data-type="plain">Plain Text</button>
            <button class="tab" data-type="rich">Rich Text</button>
            <button class="tab" data-type="task">Task List</button>
          </div>

          <div class="form-group">
            <input type="text" id="title" placeholder="Ti√™u ƒë·ªÅ ghi ch√∫..." />
          </div>

          <div id="plainEditor" class="editor-container">
            <textarea id="plainContent" placeholder="Nh·∫≠p n·ªôi dung..." style="min-height:400px; font-family:monospace"></textarea>
          </div>

          <div id="richEditor" class="editor-container hidden">
            <div id="editor"></div>
          </div>

          <div id="taskEditor" class="editor-container hidden">
            <div id="taskList"></div>
            <button id="btnAddTask" class="ghost" style="margin-top:10px">+ Th√™m c√¥ng vi·ªác</button>
          </div>

          <div class="editor-toolbar">
            <button id="btnSave" class="success">üíæ L∆∞u</button>
            <button id="btnShare" class="primary">üîó Share</button>
            <button id="btnSettings" class="ghost">‚öôÔ∏è C√†i ƒë·∫∑t</button>
            <button id="btnExport" class="ghost">üì• T·∫£i xu·ªëng</button>
            <button id="btnDelete" class="danger">üóëÔ∏è X√≥a</button>
          </div>

          <div id="editorMsg" class="muted" style="margin-top:10px"></div>
        </div>
      </main>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="authModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</h3>
        <button class="modal-close" onclick="closeModal('authModal')">√ó</button>
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" placeholder="your@email.com" />
      </div>
      <div class="form-group">
        <label>M·∫≠t kh·∫©u</label>
        <input type="password" id="password" placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±" />
      </div>
      <div id="authMsg" class="muted"></div>
      <div class="btn-group">
        <button id="btnLogin" class="primary">ƒêƒÉng nh·∫≠p</button>
        <button id="btnRegister" class="secondary">ƒêƒÉng k√Ω</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üîí C√†i ƒë·∫∑t b·∫£o m·∫≠t</h3>
        <button class="modal-close" onclick="closeModal('settingsModal')">√ó</button>
      </div>
      
      <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <div class="checkbox-group" style="margin-bottom: 0;">
          <input type="checkbox" id="isPublic" checked />
          <label for="isPublic" style="font-weight: 600;">üåê Ghi ch√∫ c√¥ng khai</label>
        </div>
        <p class="muted" style="margin-left: 24px; margin-top: 5px;">Khi t·∫Øt, ch·ªâ b·∫°n m·ªõi xem ƒë∆∞·ª£c ghi ch√∫ n√†y</p>
      </div>
      
      <div class="form-group">
        <label>üîë M·∫≠t kh·∫©u xem</label>
        <input type="password" id="viewPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ b·∫£o v·ªá khi chia s·∫ª" />
        <p class="muted" style="margin-top: 5px;">Ng∆∞·ªùi kh√°c c·∫ßn nh·∫≠p m·∫≠t kh·∫©u n√†y ƒë·ªÉ xem n·ªôi dung</p>
      </div>
      
      <div class="form-group">
        <label>‚úèÔ∏è M·∫≠t kh·∫©u ch·ªânh s·ª≠a</label>
        <input type="password" id="editorPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u cho ph√©p ng∆∞·ªùi kh√°c s·ª≠a" />
        <p class="muted" style="margin-top: 5px;">Cho ph√©p ng∆∞·ªùi c√≥ m·∫≠t kh·∫©u n√†y ch·ªânh s·ª≠a ghi ch√∫ qua link chia s·∫ª</p>
      </div>
      
      <div id="settingsMsg" class="muted" style="margin-bottom: 10px;"></div>
      
      <div class="btn-group">
        <button id="btnSaveSettings" class="success">üíæ L∆∞u c√†i ƒë·∫∑t</button>
        <button id="btnClearPasswords" class="ghost">üóëÔ∏è X√≥a m·∫≠t kh·∫©u</button>
        <button class="ghost" onclick="closeModal('settingsModal')">H·ªßy</button>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div id="shareModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Chia s·∫ª ghi ch√∫</h3>
        <button class="modal-close" onclick="closeModal('shareModal')">√ó</button>
      </div>
      <div class="form-group">
        <label>Link chia s·∫ª</label>
        <input type="text" id="shareLink" readonly />
      </div>
      <div class="btn-group">
        <button id="btnCopyLink" class="primary">üìã Copy Link</button>
        <button class="ghost" onclick="closeModal('shareModal')">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    let token = localStorage.getItem('token') || ''
    let currentNoteId = null
    let notes = []
    let currentType = 'plain'
    let quillEditor = null
    let isGuest = false

    // Initialize Quill
    quillEditor = new Quill('#editor', {
      theme: 'snow',
      placeholder: 'Nh·∫≠p n·ªôi dung...',
      modules: {
        toolbar: [
          [{ 'header': [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          [{ 'color': [] }, { 'background': [] }],
          ['link', 'image'],
          ['clean']
        ]
      }
    })

    async function initGuestToken() {
      if (!token) {
        try {
          const res = await fetch('/api/guest/token')
          if (!res.ok) throw new Error('Failed to get guest token')
          const data = await res.json()
          token = data.token
          localStorage.setItem('token', token)
          isGuest = true
          console.log('Guest token created')
        } catch (e) {
          console.error('Failed to get guest token:', e)
        }
      } else {
        try {
          const decoded = JSON.parse(atob(token.split('.')[1]))
          isGuest = decoded?.isGuest || false
          console.log('Existing token loaded, isGuest:', isGuest)
        } catch (e) {
          console.error('Invalid token, clearing...')
          localStorage.removeItem('token')
          token = ''
          await initGuestToken()
        }
      }
    }

    async function api(path, opts = {}) {
      const headers = { 'Content-Type': 'application/json' }
      if (token) headers['Authorization'] = 'Bearer ' + token
      const res = await fetch(path, { ...opts, headers })
      const data = await res.json().catch(() => ({}))
      if (!res.ok) throw { status: res.status, data }
      return data
    }

    function showModal(id) {
      document.getElementById(id).classList.add('show')
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('show')
    }

    async function register() {
      const email = document.getElementById('email').value.trim()
      const password = document.getElementById('password').value
      const authMsg = document.getElementById('authMsg')
      
      if (!email || !password || password.length < 6) {
        authMsg.textContent = 'Nh·∫≠p email v√† m·∫≠t kh·∫©u (>=6 k√Ω t·ª±)'
        return
      }
      
      try {
        await api('/api/auth/register', { method: 'POST', body: JSON.stringify({ email, password }) })
        authMsg.textContent = 'ƒêƒÉng k√Ω th√†nh c√¥ng! H√£y ƒëƒÉng nh·∫≠p.'
        authMsg.style.color = '#27ae60'
      } catch (e) {
        authMsg.textContent = e.status === 409 ? 'Email ƒë√£ t·ªìn t·∫°i' : 'L·ªói ƒëƒÉng k√Ω'
        authMsg.style.color = '#e74c3c'
      }
    }

    async function login() {
      const email = document.getElementById('email').value.trim()
      const password = document.getElementById('password').value
      const authMsg = document.getElementById('authMsg')
      
      if (!email || !password) {
        authMsg.textContent = 'Nh·∫≠p email v√† m·∫≠t kh·∫©u'
        return
      }
      
      try {
        const r = await api('/api/auth/login', { method: 'POST', body: JSON.stringify({ email, password }) })
        token = r.token
        localStorage.setItem('token', token)
        closeModal('authModal')
        updateUI()
        await loadNotes()
      } catch (e) {
        authMsg.textContent = 'Sai th√¥ng tin ƒëƒÉng nh·∫≠p'
        authMsg.style.color = '#e74c3c'
      }
    }

    function updateUI() {
      try {
        const decoded = token ? JSON.parse(atob(token.split('.')[1])) : null
        isGuest = decoded?.isGuest || false
      } catch (e) {
        isGuest = false
      }
      
      const btnShowAuth = document.getElementById('btnShowAuth')
      const authStatus = document.getElementById('authStatus')
      const guestMsg = document.getElementById('guestMsg')
      
      if (token && !isGuest) {
        btnShowAuth.textContent = 'ƒêƒÉng xu·∫•t'
        btnShowAuth.onclick = logout
        authStatus.textContent = 'ƒê√£ ƒëƒÉng nh·∫≠p'
        guestMsg.classList.add('hidden')
      } else {
        btnShowAuth.textContent = 'ƒêƒÉng nh·∫≠p'
        btnShowAuth.onclick = () => showModal('authModal')
        authStatus.textContent = ''
        guestMsg.classList.remove('hidden')
      }
    }

    function logout() {
      localStorage.removeItem('token')
      token = ''
      location.reload()
    }

    async function loadNotes() {
      try {
        notes = await api('/api/notes')
        renderNotes()
      } catch (e) {
        console.error('Failed to load notes:', e)
        if (e.status === 401) {
          console.log('Token invalid, getting new guest token...')
          await initGuestToken()
          try {
            notes = await api('/api/notes')
            renderNotes()
          } catch (e2) {
            console.error('Still failed after refresh:', e2)
          }
        }
      }
    }

    function renderNotes() {
      const list = document.getElementById('notesList')
      list.innerHTML = ''
      
      notes.forEach(n => {
        const li = document.createElement('li')
        li.className = 'note-item' + (n._id === currentNoteId ? ' active' : '')
        
        // Build icons for privacy indicators
        let icons = ''
        if (n.isPublic === false) icons += '<span title="Ri√™ng t∆∞">üîí</span>'
        if (n.password) icons += '<span title="C√≥ m·∫≠t kh·∫©u xem">üîë</span>'
        if (n.editorPassword) icons += '<span title="C√≥ m·∫≠t kh·∫©u s·ª≠a">‚úèÔ∏è</span>'
        
        li.innerHTML = `
          <div class="note-item-title">
            <span>${n.title || '(Kh√¥ng c√≥ ti√™u ƒë·ªÅ)'}</span>
            <span class="note-icons">${icons}</span>
          </div>
          <div class="note-item-date">${new Date(n.updatedAt).toLocaleDateString('vi-VN')}</div>
        `
        li.onclick = () => selectNote(n._id)
        list.appendChild(li)
      })
    }

    function selectNote(id) {
      const note = notes.find(n => n._id === id)
      if (!note) return
      
      currentNoteId = id
      document.getElementById('title').value = note.title || ''
      
      currentType = note.contentType || 'plain'
      switchEditor(currentType)
      
      if (currentType === 'plain') {
        document.getElementById('plainContent').value = note.content || ''
      } else if (currentType === 'rich') {
        quillEditor.root.innerHTML = note.content || ''
      } else if (currentType === 'task') {
        renderTaskList(note.content)
      }
      
      renderNotes()
    }

    function switchEditor(type) {
      currentType = type
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
      document.querySelector(`[data-type="${type}"]`).classList.add('active')
      
      document.getElementById('plainEditor').classList.add('hidden')
      document.getElementById('richEditor').classList.add('hidden')
      document.getElementById('taskEditor').classList.add('hidden')
      
      if (type === 'plain') document.getElementById('plainEditor').classList.remove('hidden')
      else if (type === 'rich') document.getElementById('richEditor').classList.remove('hidden')
      else if (type === 'task') document.getElementById('taskEditor').classList.remove('hidden')
    }

    function renderTaskList(content) {
      const taskList = document.getElementById('taskList')
      taskList.innerHTML = ''
      
      try {
        const tasks = JSON.parse(content || '[]')
        tasks.forEach((task, idx) => {
          const div = document.createElement('div')
          div.className = 'checkbox-group'
          div.innerHTML = `
            <input type="checkbox" ${task.done ? 'checked' : ''} onchange="toggleTask(${idx})">
            <input type="text" value="${task.text}" onchange="updateTask(${idx}, this.value)" style="flex:1">
            <button class="ghost" onclick="deleteTask(${idx})" style="padding:5px 10px">√ó</button>
          `
          taskList.appendChild(div)
        })
      } catch (e) {
        console.error('Invalid task list')
      }
    }

    function getTaskList() {
      const tasks = []
      document.querySelectorAll('#taskList .checkbox-group').forEach(div => {
        const checkbox = div.querySelector('input[type="checkbox"]')
        const input = div.querySelector('input[type="text"]')
        tasks.push({ text: input.value, done: checkbox.checked })
      })
      return JSON.stringify(tasks)
    }

    window.toggleTask = function(idx) {
      const tasks = JSON.parse(getTaskList())
      tasks[idx].done = !tasks[idx].done
      renderTaskList(JSON.stringify(tasks))
    }

    window.updateTask = function(idx, text) {
      const tasks = JSON.parse(getTaskList())
      tasks[idx].text = text
    }

    window.deleteTask = function(idx) {
      const tasks = JSON.parse(getTaskList())
      tasks.splice(idx, 1)
      renderTaskList(JSON.stringify(tasks))
    }

    document.getElementById('btnAddTask').onclick = () => {
      const tasks = JSON.parse(getTaskList())
      tasks.push({ text: '', done: false })
      renderTaskList(JSON.stringify(tasks))
    }

    async function saveNote() {
      const title = document.getElementById('title').value
      let content = ''
      
      if (currentType === 'plain') {
        content = document.getElementById('plainContent').value
      } else if (currentType === 'rich') {
        content = quillEditor.root.innerHTML
      } else if (currentType === 'task') {
        content = getTaskList()
      }
      
      const editorMsg = document.getElementById('editorMsg')
      
      try {
        if (!currentNoteId) {
          const note = await api('/api/notes', {
            method: 'POST',
            body: JSON.stringify({ title, content, contentType: currentType })
          })
          notes.unshift(note)
          currentNoteId = note._id
        } else {
          const note = await api(`/api/notes/${currentNoteId}`, {
            method: 'PUT',
            body: JSON.stringify({ title, content, contentType: currentType })
          })
          const idx = notes.findIndex(n => n._id === currentNoteId)
          if (idx >= 0) notes[idx] = note
        }
        
        renderNotes()
        editorMsg.textContent = '‚úì ƒê√£ l∆∞u'
        editorMsg.style.color = '#27ae60'
        setTimeout(() => editorMsg.textContent = '', 3000)
      } catch (e) {
        if (e.status === 429) {
          editorMsg.textContent = 'Kh√°ch ch·ªâ ƒë∆∞·ª£c t·∫°o t·ªëi ƒëa 10 ghi ch√∫. Vui l√≤ng ƒëƒÉng nh·∫≠p.'
          showModal('authModal')
        } else {
          editorMsg.textContent = 'L·ªói khi l∆∞u'
        }
        editorMsg.style.color = '#e74c3c'
      }
    }

    async function deleteNote() {
      if (!currentNoteId || !confirm('X√≥a ghi ch√∫ n√†y?')) return
      
      try {
        await api(`/api/notes/${currentNoteId}`, { method: 'DELETE' })
        notes = notes.filter(n => n._id !== currentNoteId)
        currentNoteId = null
        document.getElementById('title').value = ''
        document.getElementById('plainContent').value = ''
        quillEditor.root.innerHTML = ''
        renderTaskList('[]')
        renderNotes()
      } catch (e) {
        alert('L·ªói khi x√≥a')
      }
    }

    function shareNote() {
      if (!currentNoteId) {
        alert('L∆∞u ghi ch√∫ tr∆∞·ªõc khi chia s·∫ª')
        return
      }
      
      const note = notes.find(n => n._id === currentNoteId)
      if (note && note.shareId) {
        document.getElementById('shareLink').value = location.origin + '/share/' + note.shareId
        showModal('shareModal')
      }
    }

    document.getElementById('btnCopyLink').onclick = async () => {
      const link = document.getElementById('shareLink').value
      try {
        await navigator.clipboard.writeText(link)
        alert('ƒê√£ copy link!')
      } catch (e) {
        alert('Kh√¥ng th·ªÉ copy. H√£y copy th·ªß c√¥ng.')
      }
    }

    async function exportNote() {
      if (!currentNoteId) {
        alert('Ch·ªçn ghi ch√∫ ƒë·ªÉ t·∫£i xu·ªëng')
        return
      }
      
      const note = notes.find(n => n._id === currentNoteId)
      const title = note.title || 'note'
      let content = note.content
      
      if (note.contentType === 'rich') {
        const blob = new Blob([`<!DOCTYPE html><html><head><meta charset="utf-8"><title>${title}</title></head><body>${content}</body></html>`], { type: 'text/html' })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = title + '.html'
        a.click()
      } else {
        const blob = new Blob([content], { type: 'text/plain' })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = title + '.txt'
        a.click()
      }
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => switchEditor(tab.dataset.type)
    })

    document.getElementById('btnNew').onclick = () => {
      currentNoteId = null
      document.getElementById('title').value = ''
      document.getElementById('plainContent').value = ''
      quillEditor.root.innerHTML = ''
      renderTaskList('[]')
      renderNotes()
    }

    document.getElementById('btnSave').onclick = saveNote
    document.getElementById('btnDelete').onclick = deleteNote
    document.getElementById('btnShare').onclick = shareNote
    document.getElementById('btnExport').onclick = exportNote
    document.getElementById('btnSettings').onclick = openSettings
    document.getElementById('btnSaveSettings').onclick = saveSettings
    document.getElementById('btnClearPasswords').onclick = clearPasswords
    document.getElementById('btnLogin').onclick = login
    document.getElementById('btnRegister').onclick = register

    function openSettings() {
      if (!currentNoteId) {
        alert('Vui l√≤ng ch·ªçn ho·∫∑c t·∫°o ghi ch√∫ tr∆∞·ªõc')
        return
      }
      
      const note = notes.find(n => n._id === currentNoteId)
      if (note) {
        document.getElementById('isPublic').checked = note.isPublic !== false
        document.getElementById('viewPassword').value = note.password || ''
        document.getElementById('editorPassword').value = note.editorPassword || ''
        document.getElementById('settingsMsg').textContent = ''
      }
      showModal('settingsModal')
    }

    async function saveSettings() {
      if (!currentNoteId) return
      
      const isPublic = document.getElementById('isPublic').checked
      const password = document.getElementById('viewPassword').value.trim() || null
      const editorPassword = document.getElementById('editorPassword').value.trim() || null
      const settingsMsg = document.getElementById('settingsMsg')
      
      try {
        const note = await api(`/api/notes/${currentNoteId}`, {
          method: 'PUT',
          body: JSON.stringify({ isPublic, password, editorPassword })
        })
        
        // Update local notes array
        const idx = notes.findIndex(n => n._id === currentNoteId)
        if (idx >= 0) notes[idx] = note
        
        renderNotes()
        settingsMsg.textContent = '‚úì ƒê√£ l∆∞u c√†i ƒë·∫∑t b·∫£o m·∫≠t'
        settingsMsg.style.color = '#27ae60'
        
        setTimeout(() => closeModal('settingsModal'), 1500)
      } catch (e) {
        settingsMsg.textContent = 'L·ªói khi l∆∞u c√†i ƒë·∫∑t'
        settingsMsg.style.color = '#e74c3c'
      }
    }

    function clearPasswords() {
      document.getElementById('viewPassword').value = ''
      document.getElementById('editorPassword').value = ''
      document.getElementById('settingsMsg').textContent = 'ƒê√£ x√≥a m·∫≠t kh·∫©u. Nh·∫•n "L∆∞u c√†i ƒë·∫∑t" ƒë·ªÉ √°p d·ª•ng.'
      document.getElementById('settingsMsg').style.color = '#f39c12'
    }


    ;(async () => {
      console.log('Initializing app...')
      await initGuestToken()
      updateUI()
      if (token) {
        console.log('Loading notes...')
        await loadNotes()
      }
      console.log('App ready!')
    })()
  </script>
</body>
</html>
